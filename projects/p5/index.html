<!DOCTYPE html>
<html>
    <head>
        <title>Media</title>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
        <style>
          #frameCanvas {display:none;}
          button {font-size: 2em;}
        </style>

    </head>
    <body>
        <h1>Fun with Camera, Canvas and Google Cloud Vision Face Detection</h1>
        <p>When you click the button, the script will capture the current video frame, send it to Google Cloud Vision, get the bounding box of the face from the response data (and a TODO is to handle the "no face" condition, which currently stops the script), then pastes just the face into another canvas, making a collage of faces.  Another update is to make it copy/paste <em>all</em> the faces in the image;  currently, it just handles the first.</p>
        <video id="player" controls autoplay></video>
        <button id="capture">Capture</button>
        <div id="templateFace">
          <canvas style="display: inline-block"><!-- Face of image goes here --></canvas>
          <p style="display: inline-block"><!-- Labels go here --></p>
        </div>
        <canvas id="canvas" width=320 height=240></canvas>
        <div id="imageData"></div>
        

        
        <script>
          const player = document.getElementById('player');
          const frameCanvas = document.getElementById('frameCanvas');
          const collageCanvas = document.getElementById('collageCanvas');
          const canvas = document.getElementById('canvas');
          const context = canvas.getContext('2d');
          const captureButton = document.getElementById('capture');
          var requestBody = "";
          var doFaceCapture = false;
          
          collageCanvas.width = window.innerWidth;
          collageCanvas.height = 300;
          
          const constraints = {
            video: true,
          };
           captureButton.addEventListener('click', () => {
            context.drawImage(player, 0, 0, canvas.width, canvas.height);
            getImageData();
          });

          
          // Attach the video stream to the video element and autoplay.
          navigator.mediaDevices.getUserMedia(constraints)
            .then((stream) => {
              player.srcObject = stream;
            });
            
            
            
          function getImageData(type) {
             // capture the video frame to the hidden canvas
             
             // create the request body
            requestBody = {
                  "requests":[
                    {
                      "image":{
                        "content": canvas.toDataURL().split(",")[1]
                      },
                      "features":[
                        {
                          "type":"FACE_DETECTION"
                        },
                        {
                          "type":"LABEL_DETECTION",
                          "maxResults":10
                        }
                      ]
                    }
                  ]
                }
            
            // send the data to Google Cloud Vision
            $.ajax({
                method: "POST",
                contentType: "application/json",
                url: "https://vision.googleapis.com/v1/images:annotate?key=AIzaSyAM-NxYi-E6HD1N18M75-jbqIwuo-CDzSA",
                data: JSON.stringify(requestBody)
              })
                .done(function(response) {
                  if (f[0].faceAnnotations != undefined && f[0].faceAnnotations.length > 0) {
                      // calculate start position and size
                      var vertices = f[0].faceAnnotations[0].boundingPoly.vertices; // only take first face
                      var startX = vertices[0].x;
                      var startY = vertices[0].y;
                      var width = vertices[2].x - vertices[0].x;
                      var height = vertices[2].y - vertices[0].y;
                      
                      var face = $("#templateFace").clone().attr("id", "face" + currentId);
                      face.find("canvas").attr("width", width).attr("height", height);
                      const canvas2 = face.find("canvas").get(0);
                      currentId += 1;
                  
                  // determine width and height for cropping
                  var faceWidth = bottomRight.x - topLeft.x;
                  var faceHeight = bottomRight.y - topLeft.y;
                  var sourceX = topLeft.x;
                  var sourceY = topLeft.y;
                  var destWidth = faceWidth;
                  var destHeight = faceHeight;


                  // check to see whether we need to start a new row or column
                   var labels = "";
                      if (f[0].labelAnnotations != undefined) {
                        $.each(f[0].labelAnnotations, function(j, l) {
                          labels += l.description + ":" + l.score + "<br>";
                        });
                      } else {
                        labels = "No labels";
                      }
                      face.find("p").html(labels);
                      
                      // add to imageData
                     const context2 = canvas2.getContext('2d');
                      context2.drawImage(canvas, startX, startY, width, height, 0, 0, canvas2.width, canvas2.height);
                    } else {
                      $("#imageData").prepend("<p>No Face Detected</p>")
                    }
                  });
          };
          }
        </script>
    </body>
</html>